#include "patchset.h"

#include <vector>
#include <fstream>
#include <iterator>
#include <iostream>
#include <string>
#include <filesystem>
#include <sstream>

#include "json.hpp"

#define HEX_BASE ( 16 )

std::vector<PatchSet> patchsets;

static void init()
{
    std::string name = "FLASH512";
    auto* patchset = new PatchSet(name);
    patchset->addPatch(std::vector<unsigned char> {(0xf0),(0xb5),(0xa0),(0xb0),(0x0d),(0x1c),(0x16),(0x1c),
                                                   (0x1f),(0x1c),(0x03),(0x04),(0x1c),(0x0c),(0x0f),(0x4a),
                                                   (0x10),(0x88),(0x0f),(0x49),(0x08),(0x40),(0x03),(0x21),
                                                   (0x08),(0x43),(0x10),(0x80),(0x0d),(0x48),(0x00),(0x68),
                                                   (0x01),(0x68),(0x80),(0x20),(0x80),(0x02)},
                       std::vector<unsigned char> {(0x70),(0xb5),(0xa0),(0xb0),(0x00),(0x03),(0x40),(0x18),
                                                   (0xe0),(0x21),(0x09),(0x05),(0x09),(0x18),(0x08),(0x78),
                                                   (0x10),(0x70),(0x01),(0x3b),(0x01),(0x32),(0x01),(0x31),
                                                   (0x00),(0x2b),(0xf8),(0xd1),(0x00),(0x20),(0x20),(0xb0),
                                                   (0x70),(0xbc),(0x02),(0xbc),(0x08),(0x47)});
    patchset->addPatch(std::vector<unsigned char> {(0xff),(0xf7),(0x88),(0xfd),(0x00),(0x04),(0x03),(0x0c)},
                       std::vector<unsigned char> {(0x1b),(0x23),(0x1b),(0x02),(0x32),(0x20),(0x03),(0x43)});
    patchset->addPatch(std::vector<unsigned char> {(0x70),(0xb5),(0x90),(0xb0),(0x15),(0x4d),(0x29),(0x88)},
                       std::vector<unsigned char> {(0x00),(0xb5),(0x00),(0x20),(0x02),(0xbc),(0x08),(0x47)});
    patchset->addPatch(std::vector<unsigned char> {(0x70),(0xb5),(0x46),(0x46),(0x40),(0xb4),(0x90),(0xb0)},
                       std::vector<unsigned char> {(0x00),(0xb5),(0x00),(0x20),(0x02),(0xbc),(0x08),(0x47)});
    patchset->addPatch(std::vector<unsigned char> {(0xf0),(0xb5),(0x90),(0xb0),(0x0f),(0x1c),(0x00),(0x04),
                                                   (0x04),(0x0c),(0x03),(0x48),(0x00),(0x68),(0x40),(0x89),
                                                   (0x84),(0x42),(0x05),(0xd3),(0x01),(0x48),(0x41),(0xe0)},
                       std::vector<unsigned char> {(0x7c),(0xb5),(0x90),(0xb0),(0x00),(0x03),(0x0a),(0x1c),
                                                   (0xe0),(0x21),(0x09),(0x05),(0x09),(0x18),(0x01),(0x23),
                                                   (0x1b),(0x03),(0x10),(0x78),(0x08),(0x70),(0x01),(0x3b),
                                                   (0x01),(0x32),(0x01),(0x31),(0x00),(0x2b),(0xf8),(0xd1),
                                                   (0x00),(0x20),(0x10),(0xb0),(0x7c),(0xbc),(0x02),(0xbc),
                                                   (0x08),(0x47)});
    patchsets.push_back(*patchset);

    name = "FLASH1M_V102";

    patchset = new PatchSet(name);

    patchset->addPatch(std::vector<unsigned char> {(0x05), (0x4b), (0xaa), (0x21), (0x19), (0x70), (0x05), (0x4a),
                                                   (0x55), (0x21), (0x11), (0x70), (0xb0), (0x21), (0x19), (0x70),
                                                   (0xe0), (0x21), (0x09), (0x05), (0x08), (0x70), (0x70), (0x47)},
                       std::vector<unsigned char> {(0x05), (0x4B), (0x80), (0x21), (0x09), (0x02), (0x09), (0x22),
                                                   (0x12), (0x06), (0x9F), (0x44), (0x90), (0x21), (0x09), (0x05),
                                                   (0x00), (0x00), (0x00), (0x00), (0x08), (0x70), (0x70), (0x47)});
    patchset->addPatch(std::vector<unsigned char> {(0x55), (0x55), (0x00), (0x0e), (0xaa), (0x2a), (0x00), (0x0e),
                                                   (0x30), (0xb5), (0x91), (0xb0), (0x68), (0x46), (0x00), (0xf0),
                                                   (0xf3), (0xf8), (0x6d), (0x46), (0x01), (0x35)},
                       std::vector<unsigned char> {(0xFE), (0xFF), (0xFF), (0x01), (0x00), (0x00), (0x00), (0x00),
                                                   (0x30), (0xB5), (0x91), (0xB0), (0x68), (0x46), (0x00), (0xF0),
                                                   (0xF3), (0xF8), (0x6D), (0x46), (0x01), (0x35)});
    patchset->addPatch(std::vector<unsigned char> {(0x06), (0x4A), (0xAA), (0x20), (0x10), (0x70), (0x05), (0x49),
                                                   (0x55), (0x20), (0x08), (0x70), (0x90), (0x20), (0x10), (0x70),
                                                   (0x10), (0xA9), (0x03), (0x4A), (0x10), (0x1C), (0x08), (0xE0),
                                                   (0x00), (0x00), (0x55), (0x55), (0x00), (0x0E), (0xAA), (0x2A),
                                                   (0x00), (0x0E), (0x20), (0x4E), (0x00), (0x00), (0x08), (0x88),
                                                   (0x01), (0x38), (0x08), (0x80), (0x08), (0x88), (0x00), (0x28),
                                                   (0xF9), (0xD1), (0x0C), (0x48)},
                       std::vector<unsigned char> {(0x06), (0x4A), (0xAA), (0x20), (0x00), (0x00), (0x05), (0x49),
                                                   (0x55), (0x20), (0x00), (0x00), (0x90), (0x20), (0x00), (0x00),
                                                   (0x10), (0xA9), (0x03), (0x4A), (0x10), (0x1C), (0x08), (0xE0),
                                                   (0x00), (0x00), (0x55), (0x55), (0x00), (0x0E), (0xAA), (0x2A),
                                                   (0x00), (0x0E), (0x20), (0x4E), (0x00), (0x00), (0x08), (0x88),
                                                   (0x01), (0x38), (0x08), (0x80), (0x08), (0x88), (0x00), (0x28),
                                                   (0xF9), (0xD1), (0x0C), (0x48), (0x13), (0x20), (0x13), (0x20),
                                                   (0x00), (0x06), (0x04), (0x0C), (0xE0), (0x20), (0x00), (0x05),
                                                   (0x62), (0x20), (0x62), (0x20), (0x00), (0x06), (0x00), (0x0E),
                                                   (0x04), (0x43), (0x07), (0x49), (0xAA), (0x20), (0x00), (0x00),
                                                   (0x07), (0x4A), (0x55), (0x20), (0x00), (0x00), (0xF0), (0x20),
                                                   (0x00), (0x00), (0x00), (0x00)});
    patchset->addPatch(std::vector<unsigned char> {(0x14), (0x49), (0xAA), (0x24), (0x0C), (0x70), (0x13), (0x4B),
                                                   (0x55), (0x22), (0x1A), (0x70), (0x80), (0x20), (0x08), (0x70),
                                                   (0x0C), (0x70), (0x1A), (0x70), (0x10), (0x20), (0x08), (0x70)},
                       std::vector<unsigned char> {(0x0E), (0x21), (0x09), (0x06), (0xFF), (0x24), (0x80), (0x22),
                                                   (0x13), (0x4B), (0x52), (0x02), (0x01), (0x3A), (0x8C), (0x54),
                                                   (0xFC), (0xD1), (0x00), (0x00), (0x00), (0x00), (0x00), (0x00)});
    patchset->addPatch(std::vector<unsigned char> {(0x13), (0x49), (0xAA), (0x25), (0x0D), (0x70), (0x13), (0x4B),
                                                   (0x55), (0x22), (0x1A), (0x70), (0x80), (0x20), (0x08), (0x70),
                                                   (0x0D), (0x70), (0x1A), (0x70), (0x30), (0x20), (0x20), (0x70)},
                       std::vector<unsigned char> {(0x13), (0x49), (0xFF), (0x25), (0x08), (0x22), (0x00), (0x00),
                                                   (0x52), (0x02), (0x01), (0x3A), (0xA5), (0x54), (0xFC), (0xD1),
                                                   (0x00), (0x00), (0x00), (0x00), (0x00), (0x00), (0x00), (0x00)});
    patchset->addPatch(std::vector<unsigned char> {(0x0A), (0x4C), (0xAA), (0x22), (0x22), (0x70), (0x09), (0x4B),
                                                   (0x55), (0x22), (0x1A), (0x70), (0xA0), (0x22), (0x22), (0x70),
                                                   (0x02), (0x78), (0x0A), (0x70)},
                       std::vector<unsigned char> {(0x0A), (0x4C), (0xAA), (0x22), (0x00), (0x00), (0x09), (0x4B),
                                                   (0x55), (0x22), (0x00), (0x00), (0xA0), (0x22), (0x00), (0x00),
                                                   (0x02), (0x78), (0x0A), (0x70)});

    patchsets.push_back(*patchset);

    name = "FLASH1M_V103";

    patchset = new PatchSet(name);

    patchset->addPatch(std::vector<unsigned char> {(0x05), (0x4b), (0xaa), (0x21), (0x19), (0x70), (0x05), (0x4a),
                                                   (0x55), (0x21), (0x11), (0x70), (0xb0), (0x21), (0x19), (0x70),
                                                   (0xe0), (0x21), (0x09), (0x05), (0x08), (0x70), (0x70), (0x47)},
                       std::vector<unsigned char> {(0x05), (0x4B), (0x80), (0x21), (0x09), (0x02), (0x09), (0x22),
                                                   (0x12), (0x06), (0x9F), (0x44), (0x90), (0x21), (0x09), (0x05),
                                                   (0x00), (0x00), (0x00), (0x00), (0x08), (0x70), (0x70), (0x47)});
    patchset->addPatch(std::vector<unsigned char> {(0x55), (0x55), (0x00), (0x0e), (0xaa), (0x2a), (0x00), (0x0e),
                                                   (0x30), (0xb5), (0x91), (0xb0), (0x68), (0x46), (0x00), (0xf0),
                                                   (0xf3), (0xf8), (0x6d), (0x46), (0x01), (0x35)},
                       std::vector<unsigned char> {(0xFE), (0xFF), (0xFF), (0x01), (0x00), (0x00), (0x00), (0x00),
                                                   (0x30), (0xB5), (0x91), (0xB0), (0x68), (0x46), (0x00), (0xF0),
                                                   (0xF3), (0xF8), (0x6D), (0x46), (0x01), (0x35)});
    patchset->addPatch(std::vector<unsigned char> {(0x06), (0x4A), (0xAA), (0x20), (0x10), (0x70), (0x05), (0x49),
                                                   (0x55), (0x20), (0x08), (0x70), (0x90), (0x20), (0x10), (0x70),
                                                   (0x10), (0xA9), (0x03), (0x4A), (0x10), (0x1C), (0x08), (0xE0),
                                                   (0x00), (0x00), (0x55), (0x55), (0x00), (0x0E), (0xAA), (0x2A),
                                                   (0x00), (0x0E), (0x20), (0x4E), (0x00), (0x00), (0x08), (0x88),
                                                   (0x01), (0x38), (0x08), (0x80), (0x08), (0x88), (0x00), (0x28),
                                                   (0xF9), (0xD1), (0x0C), (0x48)},
                       std::vector<unsigned char> {(0x06), (0x4A), (0xAA), (0x20), (0x00), (0x00), (0x05), (0x49),
                                                   (0x55), (0x20), (0x00), (0x00), (0x90), (0x20), (0x00), (0x00),
                                                   (0x10), (0xA9), (0x03), (0x4A), (0x10), (0x1C), (0x08), (0xE0),
                                                   (0x00), (0x00), (0x55), (0x55), (0x00), (0x0E), (0xAA), (0x2A),
                                                   (0x00), (0x0E), (0x20), (0x4E), (0x00), (0x00), (0x08), (0x88),
                                                   (0x01), (0x38), (0x08), (0x80), (0x08), (0x88), (0x00), (0x28),
                                                   (0xF9), (0xD1), (0x0C), (0x48), (0x13), (0x20), (0x13), (0x20),
                                                   (0x00), (0x06), (0x04), (0x0C), (0xE0), (0x20), (0x00), (0x05),
                                                   (0x62), (0x20), (0x62), (0x20), (0x00), (0x06), (0x00), (0x0E),
                                                   (0x04), (0x43), (0x07), (0x49), (0xAA), (0x20), (0x00), (0x00),
                                                   (0x07), (0x4A), (0x55), (0x20), (0x00), (0x00), (0xF0), (0x20),
                                                   (0x00), (0x00), (0x00), (0x00)});
    patchset->addPatch(std::vector<unsigned char> {(0x14), (0x49), (0xAA), (0x24), (0x0C), (0x70), (0x13), (0x4B),
                                                   (0x55), (0x22), (0x1A), (0x70), (0x80), (0x20), (0x08), (0x70),
                                                   (0x0C), (0x70), (0x1A), (0x70), (0x10), (0x20), (0x08), (0x70)},
                       std::vector<unsigned char> {(0x0E), (0x21), (0x09), (0x06), (0xFF), (0x24), (0x80), (0x22),
                                                   (0x13), (0x4B), (0x52), (0x02), (0x01), (0x3A), (0x8C), (0x54),
                                                   (0xFC), (0xD1), (0x00), (0x00), (0x00), (0x00), (0x00), (0x00)});
    patchset->addPatch(std::vector<unsigned char> {(0x14), (0x49), (0xAA), (0x25), (0x0D), (0x70), (0x14), (0x4B),
                                                   (0x55), (0x22), (0x1A), (0x70), (0x80), (0x20), (0x08), (0x70),
                                                   (0x0D), (0x70), (0x1A), (0x70), (0x30), (0x20), (0x20), (0x70)},
                       std::vector<unsigned char> {(0x14), (0x49), (0xFF), (0x25), (0x08), (0x22), (0x00), (0x00),
                                                   (0x52), (0x02), (0x01), (0x3A), (0xA5), (0x54), (0xFC), (0xD1),
                                                   (0x00), (0x00), (0x00), (0x00), (0x00), (0x00), (0x00), (0x00)});
    patchset->addPatch(std::vector<unsigned char> {(0x0C), (0x4A), (0xAA), (0x20), (0x10), (0x70), (0x0B), (0x49),
                                                   (0x55), (0x20), (0x08), (0x70), (0xA0), (0x20), (0x10), (0x70),
                                                   (0x27), (0x70), (0x09), (0x48)},
                       std::vector<unsigned char> {(0x0C), (0x4A), (0xAA), (0x20), (0x00), (0x00), (0x0B), (0x49),
                                                   (0x55), (0x20), (0x00), (0x00), (0xA0), (0x20), (0x00), (0x00),
                                                   (0x27), (0x70), (0x09), (0x48)});
    patchset->addPatch(std::vector<unsigned char> {(0x0A), (0x4C), (0xAA), (0x22), (0x22), (0x70), (0x09), (0x4B),
                                                   (0x55), (0x22), (0x1A), (0x70), (0xA0), (0x22), (0x22), (0x70),
                                                   (0x02), (0x78), (0x0A), (0x70)},
                       std::vector<unsigned char> {(0x0A), (0x4C), (0xAA), (0x22), (0x00), (0x00), (0x09), (0x4B),
                                                   (0x55), (0x22), (0x00), (0x00), (0xA0), (0x22), (0x00), (0x00),
                                                   (0x02), (0x78), (0x0A), (0x70)});

    patchsets.push_back(*patchset);

    std::vector<std::string> names = std::vector<std::string> ({"EEPROM_V120", "EEPROM_V121", "EEPROM_V122"});

    patchset = new PatchSet(names);

    patchset->addPatch(std::vector<unsigned char> {(0xa2),(0xb0),(0x0d),(0x1c),(0x00),(0x04),(0x03),(0x0c),
                                                   (0x03),(0x48),(0x00),(0x68),(0x80),(0x88),(0x83),(0x42),
                                                   (0x05),(0xd3),(0x01),(0x48),(   0),(0xe0)},
                       std::vector<unsigned char> {(0x00),(0x04),(0x0a),(0x1c),(0x40),(0x0b),(0xe0),(0x21),
                                                   (0x09),(0x05),(0x41),(0x18),(0x07),(0x31),(0x00),(0x23),
                                                   (0x08),(0x78),(0x10),(0x70),(0x01),(0x33),(0x01),(0x32),
                                                   (0x01),(0x39),(0x07),(0x2b),(0xf8),(0xd9),(0x00),(0x20),
                                                   (0x70),(0xbc),(0x02),(0xbc),(0x08),(0x47)},
                       std::vector<bool> {(false),(false),(false),(false),(false),(false),(false),(false),
                                          (false),(false),(false),(false),(false),(false),(false),(false),
                                          (false),(false),(false),(false),(true),(false)});
    patchset->addPatch(std::vector<unsigned char> {(0x30),(0xb5),(0xa9),(0xb0),(0x0d),(0x1c),(0x00),(0x04),
                                                   (0x04),(0x0c),(0x03),(0x48),(0x00),(0x68),(0x80),(0x88),
                                                   (0x84),(0x42),(0x05),(0xd3),(0x01),(0x48),(   0),(0xe0)},
                       std::vector<unsigned char> {(0x70),(0xb5),(0x00),(0x04),(0x0a),(0x1c),(0x40),(0x0b),
                                                   (0xe0),(0x21),(0x09),(0x05),(0x41),(0x18),(0x07),(0x31),
                                                   (0x00),(0x23),(0x10),(0x78),(0x08),(0x70),(0x01),(0x33),
                                                   (0x01),(0x32),(0x01),(0x39),(0x07),(0x2b),(0xf8),(0xd9),
                                                   (0x00),(0x20),(0x70),(0xbc),(0x02),(0xbc),(0x08),(0x47)},
                       std::vector<bool> {(false),(false),(false),(false),(false),(false),(false),(false),
                                          (false),(false),(false),(false),(false),(false),(false),(false),
                                          (false),(false),(false),(false),(false),(false),( true),(false)});

    patchsets.push_back(*patchset);

    name = "EEPROM_V124";

    patchset = new PatchSet(name);

    patchset->addPatch(std::vector<unsigned char> {(0xa2),(0xb0),(0x0d),(0x1c),(0x00),(0x04),(0x03),(0x0c),
                                                   (0x03),(0x48),(0x00),(0x68),(0x80),(0x88),(0x83),(0x42),
                                                   (0x05),(0xd3),(0x01),(0x48),(   0),(0xe0)},
                       std::vector<unsigned char> {(0x00),(0x04),(0x0a),(0x1c),(0x40),(0x0b),(0xe0),(0x21),
                                                   (0x09),(0x05),(0x41),(0x18),(0x07),(0x31),(0x00),(0x23),
                                                   (0x08),(0x78),(0x10),(0x70),(0x01),(0x33),(0x01),(0x32),
                                                   (0x01),(0x39),(0x07),(0x2b),(0xf8),(0xd9),(0x00),(0x20),
                                                   (0x70),(0xbc),(0x02),(0xbc),(0x08),(0x47)},
                       std::vector<bool> {(false),(false),(false),(false),(false),(false),(false),(false),
                                          (false),(false),(false),(false),(false),(false),(false),(false),
                                          (false),(false),(false),(false),( true),(false)});
    patchset->addPatch(std::vector<unsigned char> {(0xf0),(0xb5),(0xac),(0xb0),(0x0d),(0x1c),(0x00),(0x04),
                                                   (0x01),(0x0c),(0x12),(0x06),(0x17),(0x0e),(0x03),(0x48),
                                                   (0x00),(0x68),(0x80),(0x88),(0x81),(0x42),(0x05),(0xd3)},
                       std::vector<unsigned char> {(0x70),(0xb5),(0x00),(0x04),(0x0a),(0x1c),(0x40),(0x0b),
                                                   (0xe0),(0x21),(0x09),(0x05),(0x41),(0x18),(0x07),(0x31),
                                                   (0x00),(0x23),(0x10),(0x78),(0x08),(0x70),(0x01),(0x33),
                                                   (0x01),(0x32),(0x01),(0x39),(0x07),(0x2b),(0xf8),(0xd9),
                                                   (0x00),(0x20),(0x70),(0xbc),(0x02),(0xbc),(0x08),(0x47)});

    patchsets.push_back(*patchset);

    name = "EEPROM_V126";

    patchset = new PatchSet(name);

    patchset->addPatch(std::vector<unsigned char> {(0xa2),(0xb0),(0x0d),(0x1c),(0x00),(0x04),(0x03),(0x0c),
                                                   (0x03),(0x48),(0x00),(0x68),(0x80),(0x88),(0x83),(0x42),
                                                   (0x05),(0xd3),(0x01),(0x48),(0x4a),(0xe0)},
                       std::vector<unsigned char> {(0x00),(0x04),(0x0a),(0x1c),(0x40),(0x0b),(0xe0),(0x21),
                                                   (0x09),(0x05),(0x41),(0x18),(0x07),(0x31),(0x00),(0x23),
                                                   (0x08),(0x78),(0x10),(0x70),(0x01),(0x33),(0x01),(0x32),
                                                   (0x01),(0x39),(0x07),(0x2b),(0xf8),(0xd9),(0x00),(0x20),
                                                   (0x70),(0xbc),(0x02),(0xbc),(0x08),(0x47)});

    patchset->addPatch(std::vector<unsigned char> {(0xf0),(0xb5),(0x47),(0x46),(0x80),(0xb4),(0xac),(0xb0),
                                                   (0x0e),(0x1c),(0x00),(0x04),(0x05),(0x0c),(0x12),(0x06),
                                                   (0x12),(0x0e),(0x90),(0x46),(0x03),(0x48),(0x00),(0x68)},
                       std::vector<unsigned char> {(0x70),(0xb5),(0x00),(0x04),(0x0a),(0x1c),(0x40),(0x0b),
                                                   (0xe0),(0x21),(0x09),(0x05),(0x41),(0x18),(0x07),(0x31),
                                                   (0x00),(0x23),(0x10),(0x78),(0x08),(0x70),(0x01),(0x33),
                                                   (0x01),(0x32),(0x01),(0x39),(0x07),(0x2b),(0xf8),(0xd9),
                                                   (0x00),(0x20),(0x70),(0xbc),(0x02),(0xbc),(0x08),(0x47)});

    patchsets.push_back(*patchset);

    names = std::vector<std::string> ({"FLASH_V120", "FLASH_V121"});

    patchset = new PatchSet(names);

    patchset->addPatch(std::vector<unsigned char> {(0x90),(0xb5),(0x93),(0xb0),(0x6f),(0x46),(0x39),(0x1d),
                                                   (0x08),(0x1c),(0x00),(0xf0)},
                       std::vector<unsigned char> {(0x00),(0xb5),(0x3d),(0x20),(0x00),(0x02),(0x1f),(0x21),
                                                   (0x08),(0x43),(0x02),(0xbc),(0x08),(0x47)});
    patchset->addPatch(std::vector<unsigned char> {(0x80),(0xb5),(0x94),(0xb0),(0x6f),(0x46),(0x39),(0x1c),
                                                   (0x08),(0x80),(0x38),(0x1c),(0x01),(0x88),(0x0f),(0x29),
                                                   (0x04),(0xd9),(0x01),(0x48),(0x56),(0xe0),(0x00),(0x00),
                                                   (0xff),(0x80),(0x00),(0x00),(0x23),(0x48),(0x23),(0x49),
                                                   (0x0a),(0x88),(0x23)},
                       std::vector<unsigned char> {(0x7c),(0xb5),(0x00),(0x07),(0x00),(0x0c),(0xe0),(0x21),
                                                   (0x09),(0x05),(0x09),(0x18),(0x01),(0x23),(0x1b),(0x03),
                                                   (0xff),(0x20),(0x08),(0x70),(0x01),(0x3b),(0x01),(0x31),
                                                   (0x00),(0x2b),(0xfa),(0xd1),(0x00),(0x20),(0x7c),(0xbc),
                                                   (0x02),(0xbc),(0x08),(0x47)});
    patchset->addPatch(std::vector<unsigned char> {(0x80),(0xb5),(0x94),(0xb0),(0x6f),(0x46),(0x79),(0x60),
                                                   (0x39),(0x1c),(0x08),(0x80),(0x38),(0x1c),(0x01),(0x88),
                                                   (0x0f),(0x29),(0x03),(0xd9),(0x00),(0x48),(0x73),(0xe0),
                                                   (0xff),(0x80),(0x00),(0x00),(0x38),(0x1c),(0x01),(0x88)},
                       std::vector<unsigned char> {(0x7c),(0xb5),(0x90),(0xb0),(0x00),(0x03),(0x0a),(0x1c),
                                                   (0xe0),(0x21),(0x09),(0x05),(0x09),(0x18),(0x01),(0x23),
                                                   (0x1b),(0x03),(0x10),(0x78),(0x08),(0x70),(0x01),(0x3b),
                                                   (0x01),(0x32),(0x01),(0x31),(0x00),(0x2b),(0xf8),(0xd1),
                                                   (0x00),(0x20),(0x10),(0xb0),(0x7c),(0xbc),(0x08),(0xbc),
                                                   (0x08),(0x47)});
    patchsets.push_back(*patchset);

    names = std::vector<std::string> ({"FLASH_V123", "FLASH_V124"});

    patchset = new PatchSet(names);

    patchset->addPatch(std::vector<unsigned char> {(0xff),(0xf7),(0xaa),(0xff),(0x00),(0x04),(0x03),(0x0c)},
                       std::vector<unsigned char> {(0x1b),(0x23),(0x1b),(0x02),(0x32),(0x20),(0x03),(0x43)});

    patchset->addPatch(std::vector<unsigned char> {(0x70),(0xb5),(0x90),(0xb0),(0x15),(0x4d)},
                       std::vector<unsigned char> {(0x00),(0x20),(0x70),(0x47),(0x15),(0x4d)});

    patchset->addPatch(std::vector<unsigned char> {(0x70),(0xb5),(0x46),(0x46),(0x40),(0xb4),(0x90),(0xb0),
                                                   (0x00)},
                       std::vector<unsigned char> {(0x00),(0x20),(0x70),(0x47),(0x40),(0xb4),(0x90),(0xb0),
                                                   (0x00)});
    patchset->addPatch(std::vector<unsigned char> {(0xf0),(0xb5),(0x90),(0xb0),(0x0f),(0x1c),(0x00),(0x04),
                                                   (0x04),(0x0c),(0x0f),(0x2c),(0x04),(0xd9),(0x01),(0x48),
                                                   (0x40),(0xe0),(0x00),(0x00),(0xff),(0x80),(0x00),(0x00),
                                                   (0x20),(0x1c),(0xff),(0xf7),(0xd7),(0xfe),(0x00),(0x04),
                                                   (0x05),(0x0c),(0x00),(0x2d),(0x35),(0xd1)},
                       std::vector<unsigned char> {(0x70),(0xb5),(0x00),(0x03),(0x0a),(0x1c),(0xe0),(0x21),
                                                   (0x09),(0x05),(0x41),(0x18),(0x01),(0x23),(0x1b),(0x03),
                                                   (0x10),(0x78),(0x08),(0x70),(0x01),(0x3b),(0x01),(0x32),
                                                   (0x01),(0x31),(0x00),(0x2b),(0xf8),(0xd1),(0x00),(0x20),
                                                   (0x70),(0xbc),(0x02),(0xbc),(0x08),(0x47)});

    patchsets.push_back(*patchset);

    names = std::vector<std::string> ({"FLASH_V125", "FLASH_V126"});

    patchset = new PatchSet(names);

    patchset->addPatch(std::vector<unsigned char> {(0xff),(0xf7),(0xaa),(0xff),(0x00),(0x04),(0x03),(0x0c),},
                       std::vector<unsigned char> {(0x1b),(0x23),(0x1b),(0x02),(0x32),(0x20),(0x03),(0x43)});
    patchset->addPatch(std::vector<unsigned char> {(0x70),(0xb5),(0x90),(0xb0),(0x15),(0x4d)},
                       std::vector<unsigned char> {(0x00),(0x20),(0x70),(0x47),(0x15),(0x4d)});


    patchset->addPatch(std::vector<unsigned char> {(0x70),(0xb5),(0x46),(0x46),(0x40),(0xb4),(0x90),(0xb0),
                                                   (0x00),},
                       std::vector<unsigned char> {(0x00),(0x20),(0x70),(0x47),(0x40),(0xb4),(0x90),(0xb0),
                                                   (0x00)});

    patchset->addPatch(std::vector<unsigned char> {(0xf0),(0xb5),(0x90),(0xb0),(0x0f),(0x1c),(0x00),(0x04),
                                                   (0x04),(0x0c),(0x0f),(0x2c),(0x04),(0xd9),(0x01),(0x48),
                                                   (0x40),(0xe0),(0x00),(0x00),(0xff),(0x80),(0x00),(0x00),
                                                   (0x20),(0x1c),(0xff),(0xf7),(0xd7),(0xfe),(0x00),(0x04),
                                                   (0x05),(0x0c),(0x00),(0x2d),(0x35),(0xd1)},
                       std::vector<unsigned char> {(0x70),(0xb5),(0x00),(0x03),(0x0a),(0x1c),(0xe0),(0x21),
                                                   (0x09),(0x05),(0x41),(0x18),(0x01),(0x23),(0x1b),(0x03),
                                                   (0x10),(0x78),(0x08),(0x70),(0x01),(0x3b),(0x01),(0x32),
                                                   (0x01),(0x31),(0x00),(0x2b),(0xf8),(0xd1),(0x00),(0x20),
                                                   (0x70),(0xbc),(0x02),(0xbc),(0x08),(0x47)});

    patchsets.push_back(*patchset);



}


int main(int argc, char* argv[])
{
    init();
    int retCode;
    if (argc < 2)
    {
        std::cout << "Error: Use Filename as argument!" << std::endl;
        retCode = 1;
    }
    else if (!std::filesystem::exists(argv[1]))
    {
        std::cout << "Error: File does not exist!" << std::endl;
        retCode = 1;
    }
    else
    {
        std::ifstream input( argv[1], std::ios::binary );

        std::vector<unsigned char> file_buffer(std::istreambuf_iterator<char>(input), {});

        bool applied = false;

        try {

            for (PatchSet patchset : patchsets)
            {
                std::string applicableName;
                if (patchset.isApplicable(file_buffer, &applicableName))
                {
                    std::cout << "Applying patches for " << applicableName << std::endl;
                    patchset.applyPatches(&file_buffer);
                    applied = true;
                    break;
                }
            }

            if (!applied)
            {
                throw std::string("Error: Could not find applicable patchset.");
            }

            std::filesystem::path path(argv[1]);

            std::stringstream ss;
            ss << path.parent_path().string() << "output_" << path.filename().string();
            std::string outputfilename = ss.str();

            std::cout << "Success! Wrote " << outputfilename << std::endl;

            std::ofstream output(outputfilename, std::ios::out | std::ios::binary);
            output.write((char*) file_buffer.data(), file_buffer.size());
            output.close();
            retCode = 0;

        } catch (std::string& message) {
            std::cout << message << std::endl;
            retCode = 2;
        }

        

    }

    return retCode;
}
